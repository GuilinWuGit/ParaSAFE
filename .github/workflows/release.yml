name: Release

on:
  push:
    tags:
      - 'v*'

jobs:
  release:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v3
      
    - name: Extract Version
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "Release version: $VERSION"
        
    - name: Build Release
      run: |
        echo "Building release version..."
        
        # æ„å»ºæ‰€æœ‰åœºæ™¯
        cd Scenario_Lib/B_Abort_TakeOff
        g++ -std=c++17 -pthread -O2 -o abort_takeoff_sim.exe main.cpp
        
        # æ£€æŸ¥æ„å»ºç»“æœ
        if [ -f "./abort_takeoff_sim.exe" ]; then
          echo "âœ… Abort takeoff scenario built successfully"
        else
          echo "âŒ Build failed"
          exit 1
        fi
        
        # åˆ›å»ºå‘å¸ƒç›®å½•
        mkdir -p ../../release
        cp abort_takeoff_sim.exe ../../release/
        cp *.txt ../../release/ 2>/dev/null || true
        cp *.hpp ../../release/ 2>/dev/null || true
        
    - name: Create Release Assets
      run: |
        # åˆ›å»ºå‘å¸ƒåŒ…
        cd release
        tar -czf VFT-${{ steps.version.outputs.version }}-linux.tar.gz *
        
        # åˆ›å»ºWindowsç‰ˆæœ¬ï¼ˆå¦‚æœéœ€è¦ï¼‰
        # è¿™é‡Œå¯ä»¥æ·»åŠ Windowsæ„å»ºé€»è¾‘
        
        echo "Release assets created"
        
    - name: Generate Release Notes
      id: release_notes
      run: |
        # ç”Ÿæˆå‘å¸ƒè¯´æ˜
        VERSION=${{ steps.version.outputs.version }}
        
        # è·å–ä¸Šæ¬¡å‘å¸ƒæ ‡ç­¾
        PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD~1 2>/dev/null || echo "")
        
        if [ -n "$PREVIOUS_TAG" ]; then
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          CHANGELOG=$(git log --pretty=format:"- %s" $PREVIOUS_TAG..HEAD)
        else
          # é¦–æ¬¡å‘å¸ƒ
          CHANGELOG=$(git log --pretty=format:"- %s" --reverse)
        fi
        
        # åˆ›å»ºå‘å¸ƒè¯´æ˜
        cat > release_notes.md << EOF
        # VFT $VERSION Release
        
        ## ğŸ‰ What's New
        
        This release includes the following changes:
        
        $CHANGELOG
        
        ## ğŸ“¦ Installation
        
        1. Download the release assets
        2. Extract the archive
        3. Run the simulation:
           \`\`\`bash
           ./abort_takeoff_sim.exe
           \`\`\`
        
        ## ğŸ”§ System Requirements
        
        - C++17 compatible compiler
        - Linux/Windows/macOS
        - 4GB RAM minimum
        - 1GB disk space
        
        ## ğŸ“š Documentation
        
        - [Installation Guide](https://your-username.github.io/VFT/getting-started/installation)
        - [User Guide](https://your-username.github.io/VFT/user-guide/scenarios)
        - [API Reference](https://your-username.github.io/VFT/developer-guide/api-reference)
        
        ## ğŸ› Bug Reports
        
        If you encounter any issues, please report them on [GitHub Issues](https://github.com/your-username/VFT/issues)
        
        ## ğŸ¤ Contributing
        
        We welcome contributions! See our [Contributing Guide](CONTRIBUTING.md) for details.
        EOF
        
        echo "release_notes<<EOF" >> $GITHUB_OUTPUT
        cat release_notes.md >> $GITHUB_OUTPUT
        echo "EOF" >> $GITHUB_OUTPUT
        
    - name: Create GitHub Release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: ${{ steps.version.outputs.version }}
        release_name: VFT ${{ steps.version.outputs.version }}
        body: ${{ steps.release_notes.outputs.release_notes }}
        draft: false
        prerelease: false
        
    - name: Upload Release Assets
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/VFT-${{ steps.version.outputs.version }}-linux.tar.gz
        asset_name: VFT-${{ steps.version.outputs.version }}-linux.tar.gz
        asset_content_type: application/gzip
        
    - name: Update Documentation
      run: |
        # æ›´æ–°æ–‡æ¡£ä¸­çš„ç‰ˆæœ¬ä¿¡æ¯
        echo "Updating documentation..."
        
        # æ›´æ–°READMEä¸­çš„ç‰ˆæœ¬å·
        sed -i "s/Version: .*/Version: ${{ steps.version.outputs.version }}/" README.md 2>/dev/null || true
        
        # åˆ›å»ºç‰ˆæœ¬å†å²æ–‡ä»¶
        echo "# Version History" > VERSION_HISTORY.md
        echo "" >> VERSION_HISTORY.md
        echo "## ${{ steps.version.outputs.version }} - $(date +%Y-%m-%d)" >> VERSION_HISTORY.md
        echo "" >> VERSION_HISTORY.md
        echo "### Changes" >> VERSION_HISTORY.md
        echo "${{ steps.release_notes.outputs.release_notes }}" >> VERSION_HISTORY.md
        
    - name: Notify Team
      run: |
        echo "Release ${{ steps.version.outputs.version }} has been published!"
        echo "Release URL: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}"
        
        # è¿™é‡Œå¯ä»¥æ·»åŠ é€šçŸ¥é€»è¾‘ï¼Œæ¯”å¦‚å‘é€é‚®ä»¶æˆ–Slackæ¶ˆæ¯
        # curl -X POST -H 'Content-type: application/json' \
        #   --data '{"text":"VFT ${{ steps.version.outputs.version }} has been released!"}' \
        #   ${{ secrets.SLACK_WEBHOOK_URL }} 